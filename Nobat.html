
<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>Ù†ÙˆØ¨Øªâ€ŒØ¯Ù‡ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f2f5;
      direction: rtl;
      text-align: center;
      padding: 20px;
    }
    h2 {
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 600px;
      margin: auto;
    }
    .person {
      padding: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .person.active {
      border-color: teal;
      color: teal;
    }
    .person.inactive {
      background: #fcc;
      border-color: #f88;
      color: #a00;
      cursor: pointer;
    }
    .buttons {
      margin-top: 20px;
    }
    .buttons button {
      padding: 10px 20px;
      margin: 0 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .next {
      background: #00bfa6;
      color: white;
    }
    .back {
      background: gold;
    }
    .status {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2>Ù¾Ø§Ø³Ø®Ø¯Ù‡ÛŒ Ú†Øª</h2>
<div class="grid" id="grid"></div>

<div class="status" id="status">Ù†ÙˆØ¨Øª ÙØ¹Ù„ÛŒ: -</div>

<div class="buttons">
  <button class="back" onclick="prevPerson()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù†ÙØ± Ù‚Ø¨Ù„ÛŒ</button>
  <button class="next" onclick="nextPerson()">Ù†ÙØ± Ø¨Ø¹Ø¯ÛŒ ğŸ”œ</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBsgSROXymEE8kXm4Zueaae9fEZNBdfIMg",
    authDomain: "ompfinex-968c1.firebaseapp.com",
    databaseURL: "https://ompfinex-968c1-default-rtdb.firebaseio.com",
    projectId: "ompfinex-968c1",
    storageBucket: "ompfinex-968c1.firebasestorage.app",
    messagingSenderId: "875044236378",
    appId: "1:875044236378:web:b3743a5e85ac15ad167c63",
    measurementId: "G-Q65SMECMZP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const people = [
    "Ø¹Ù„ÛŒØ±Ø¶Ø§ Ø±Ø¬Ø¨ÛŒ", "Ø³Ø§Ø±Ø§ Ø¬Ø¹ÙØ±ÛŒ", "Ø³ØªØ§Ø±Ù‡ Ø·Ø§Ù„Ù‚Ø§Ù†ÛŒ", "Ø³Ø¹ÛŒØ¯ Ù…Ø¹ØµÙˆÙ…ÛŒ",
    "Ù†ÛŒÙˆØ´Ø§ Ø¹Ù„ÛŒØ²Ø§Ø¯Ù‡", "Ø³Ù‡ÛŒÙ„Ø§ Ø´ÛŒØ±Ø®Ø§Ù†ÛŒ", "Ø±ÙˆÛŒØ§ Ú©Ø§Ù‡Ø§Ù†ÛŒ", "Ú©ÛŒØ§Ù†Ø§ Ø´Ø±ÛŒÙÛŒ",
    "Ø¹Ù…Ø§Ø¯ Ø­Ø³ÛŒÙ†ÛŒ", "Ù¾Ø±ÛŒÙˆØ´ Ù…ÛŒØ±Ø´Ø§Ù‡ÛŒ", "Ø³ÙˆÚ¯Ù†Ø¯ Ø§ÙØ´Ø§Ø±ÛŒ", "Ù†Ø³ÛŒÙ… Ø§Ù†ØµØ§Ø±ÛŒ"
  ];

  const grid = document.getElementById("grid");
  const status = document.getElementById("status");

  let currentIndex = -1;
  let inactiveSet = new Set();
  let history = [];

  const stateRef = ref(db, "queueState");

  function saveState() {
    set(stateRef, {
      currentIndex,
      inactive: Array.from(inactiveSet),
      history
    });
  }

  function notifyNewPerson(name) {
    if (Notification.permission === "granted") {
      new Notification("Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯", {
        body: `Ù†ÙˆØ¨Øª ${name} Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.`,
        icon: "https://cdn-icons-png.flaticon.com/512/1827/1827349.png"
      });
    } else if (Notification.permission === "default") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          new Notification("Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯", {
            body: `Ù†ÙˆØ¨Øª ${name} Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.`,
            icon: "https://cdn-icons-png.flaticon.com/512/1827/1827349.png"
          });
        }
      });
    }
  }

  if (Notification.permission === "default") {
    Notification.requestPermission();
  }

  function renderGrid() {
    grid.innerHTML = "";
    people.forEach((name, index) => {
      const div = document.createElement("div");
      div.className = "person";

      if (inactiveSet.has(index)) {
        div.classList.add("inactive");
        div.textContent = `${name} (ØºÛŒØ±ÙØ¹Ø§Ù„/ØªÙ…Ø§Ø³)`;
      } else if (index === currentIndex) {
        div.classList.add("active");
        div.textContent = `${name} (Ø¢Ù…Ø§Ø¯Ù‡ Ù¾Ø§Ø³Ø®)`;
      } else {
        div.textContent = `${name} (ÙØ¹Ø§Ù„)`;
      }

      div.onclick = () => {
        if (index !== currentIndex) {
          if (inactiveSet.has(index)) {
            inactiveSet.delete(index);
          } else {
            inactiveSet.add(index);
          }
          saveState();
          renderGrid();
        }
      };

      grid.appendChild(div);
    });
    updateStatus();
  }

  function updateStatus() {
    if (currentIndex >= 0)
      status.textContent = `Ù†ÙˆØ¨Øª ÙØ¹Ù„ÛŒ: ${people[currentIndex]}`;
    else
      status.textContent = "Ù†ÙˆØ¨Øª ÙØ¹Ù„ÛŒ: -";
  }

  function nextPerson() {
    const oldIndex = currentIndex;
    let i = currentIndex;
    for (let step = 0; step < people.length; step++) {
      i = (i + 1) % people.length;
      if (!inactiveSet.has(i)) {
        if (currentIndex !== -1) history.push(currentIndex);
        currentIndex = i;
        if (currentIndex !== oldIndex && document.hidden) notifyNewPerson(people[currentIndex]);
        saveState();
        renderGrid();
        return;
      }
    }
    alert("Ù†ÙØ± ÙØ¹Ø§Ù„ÛŒ Ø¨Ø§Ù‚ÛŒ Ù†Ù…Ø§Ù†Ø¯Ù‡!");
  }

  function prevPerson() {
    const oldIndex = currentIndex;
    if (history.length > 0) {
      currentIndex = history.pop();
      if (currentIndex !== oldIndex && document.hidden) notifyNewPerson(people[currentIndex]);
      saveState();
      renderGrid();
    } else {
      alert("Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.");
    }
  }

  onValue(stateRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) return;
    currentIndex = data.currentIndex ?? -1;
    inactiveSet = new Set(data.inactive ?? []);
    history = data.history ?? [];
    renderGrid();
  });

  get(stateRef).then(snapshot => {
    if (!snapshot.exists()) {
      currentIndex = -1;
      inactiveSet = new Set();
      history = [];
      saveState();
    }
  });

  window.nextPerson = nextPerson;
  window.prevPerson = prevPerson;
</script>

</body>
</html>
